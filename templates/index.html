<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accent Equalizer - Real-time</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --accent-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: var(--accent-color);
            color: white;
            width: 100%;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 2rem; font-weight: 300; }
        .tagline { font-size: 1rem; opacity: 0.8; margin-top: 0.5rem; }

        main {
            width: 95%;
            max-width: 1000px;
            background: white;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .panel {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .panel h2 { color: var(--accent-color); margin-bottom: 1rem; }

        .mic-icon {
            font-size: 4rem;
            color: #ccc;
            margin: 1rem 0;
            transition: color 0.3s;
        }

        .mic-icon.active { color: var(--danger-color); animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .controls {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-start { background-color: var(--success-color); color: white; }
        .btn-start:hover { background-color: #219150; }
        
        .btn-stop { background-color: var(--danger-color); color: white; }
        .btn-stop:hover { background-color: #c0392b; }

        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        select {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-left: 1rem;
        }

        .status-display {
            margin-top: 1rem;
            font-weight: bold;
            color: var(--primary-color);
            min-height: 1.5em;
        }

        .detected-accent {
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-top: 0.5rem;
            font-weight: bold;
        }

        .log-area {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            text-align: left;
        }

        .log-entry { margin-bottom: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.2rem; }
        .log-time { color: #888; font-size: 0.8rem; margin-right: 0.5rem; }

    </style>
</head>
<body>

    <header>
        <h1>Accent Equalizer Live</h1>
        <div class="tagline">Real-time Accent Detection & Conversion</div>
    </header>

    <main>
        <div class="controls">
            <button id="startBtn" class="btn btn-start" onclick="startConversation()">Start Conversation</button>
            <button id="stopBtn" class="btn btn-stop" onclick="stopConversation()" disabled>Stop</button>
            
            <div>
                <label for="targetAccent">Target Accent:</label>
                <select id="targetAccent">
                    <option value="Neutral North American">Neutral North American</option>
                    <option value="Standard British">Standard British</option>
                    <option value="Australian">Australian</option>
                    <option value="Indian (General)">Indian (General)</option>
                    <option value="Indian (Global/Neutral)">Indian (Global/Neutral)</option>
                    <option value="Chinese (Mandarin-inflected)">Chinese (Mandarin-inflected)</option>
                    <option value="Japanese (Standard)">Japanese (Standard)</option>
                    <option value="European (French)">European (French)</option>
                    <option value="European (German)">European (German)</option>
                    <option value="European (Spanish)">European (Spanish)</option>
                </select>
            </div>
        </div>

        <div class="panel">
            <h2>You (Input)</h2>
            <div class="mic-icon" id="micIcon">ðŸŽ¤</div>
            <div>Detected Accent:</div>
            <div class="detected-accent" id="detectedAccent">Listening...</div>
            <div class="status-display" id="inputStatus">Microphone Off</div>
        </div>

        <div class="panel">
            <h2>Listener (Output)</h2>
            <div class="mic-icon" style="color: var(--primary-color);">ðŸŽ§</div>
            <div>Output Accent:</div>
            <div class="detected-accent" id="outputAccentDisplay">Neutral North American</div>
            <div class="status-display" id="outputStatus">Waiting for audio...</div>
        </div>

        <div class="log-area" id="logArea">
            <div class="log-entry">System ready. Press Start to begin.</div>
        </div>
    </main>

    <script>
        const socket = io();
        let mediaRecorder;
        let audioContext;
        let isRecording = false;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const micIcon = document.getElementById('micIcon');
        const inputStatus = document.getElementById('inputStatus');
        const outputStatus = document.getElementById('outputStatus');
        const detectedAccent = document.getElementById('detectedAccent');
        const logArea = document.getElementById('logArea');
        const targetAccentSelect = document.getElementById('targetAccent');
        const outputAccentDisplay = document.getElementById('outputAccentDisplay');

        targetAccentSelect.addEventListener('change', (e) => {
            outputAccentDisplay.textContent = e.target.value;
            log(`Target accent changed to: ${e.target.value}`);
        });

        socket.on('connect', () => {
            log('Connected to server.');
        });

        socket.on('audio_response', (data) => {
            // Play back the audio chunk
            playAudioChunk(data.audio);
            
            // Update UI with detection results
            detectedAccent.textContent = data.detected_accent;
            outputStatus.textContent = "Playing converted audio...";
            
            // Reset status after a bit
            setTimeout(() => {
                outputStatus.textContent = "Waiting for audio...";
            }, 1000);
        });

        function log(message) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logArea.prepend(div);
        }

        async function startConversation() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && socket.connected) {
                        // Send blob to server
                        const reader = new FileReader();
                        reader.onload = function() {
                            const arrayBuffer = this.result;
                            socket.emit('audio_stream', {
                                audio: arrayBuffer,
                                target_accent: targetAccentSelect.value
                            });
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };

                // Record in smaller chunks (e.g., 250ms) for lower latency
                mediaRecorder.start(250); 
                isRecording = true;

                // UI Updates
                startBtn.disabled = true;
                stopBtn.disabled = false;
                micIcon.classList.add('active');
                inputStatus.textContent = "Recording...";
                log("Microphone activated. Streaming started.");

            } catch (err) {
                console.error("Error accessing microphone:", err);
                log("Error accessing microphone: " + err.message);
                alert("Could not access microphone. Please ensure you have granted permission.");
            }
        }

        function stopConversation() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;

                // UI Updates
                startBtn.disabled = false;
                stopBtn.disabled = true;
                micIcon.classList.remove('active');
                inputStatus.textContent = "Microphone Off";
                detectedAccent.textContent = "Listening...";
                log("Streaming stopped.");
            }
        }

        function playAudioChunk(arrayBuffer) {
            // Decode and play the audio
            // Note: In a real streaming app, we'd use a SourceBuffer or AudioWorklet for smoother playback.
            // For this MVP, we decode each chunk individually which might have gaps.
            
            if (!audioContext) return;

            audioContext.decodeAudioData(arrayBuffer, (buffer) => {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
            }, (err) => {
                console.error("Error decoding audio data:", err);
            });
        }
    </script>
</body>
</html>
